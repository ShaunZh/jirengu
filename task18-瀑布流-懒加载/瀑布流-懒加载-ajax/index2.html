<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>JS Bin</title>
  <style type="text/css" media="screen">
    ul,li {
  list-style: none;
  margin: 0;
  padding: 0;
}

a {
  text-decoration: none;
}


.container {
  max-width: 1000px;
  margin: auto;
}

.pic-ct {
  position: relative;
}

#load {
  visibility: hidden;
  height: 20px;
  z-index: 1;
}

.hide {
  display: none;
}

.item {
  position: absolute;
  border: 1px solid #ccc;
  width: 280px;
  transition: all .8s;
  margin: 10px;
  opacity : 0;
}

.item img {
  width: 260px;
  margin: 10px;
}

.item h4 {
  height: 25px;
  margin: 0 10px;
  border-bottom: 1px solid #ccc;
  padding: 0 0 4px 0;
}

.item p {
  margin: 10px;
}


  </style>
</head>
<body>
  <div>
    <div class="container">
      <ul class="pic-ct">
        <li class="item hide"></li>
      </ul>
      <div id="load">锚点</div>
    </div>
  </div>
  <script type="text/javascript" src="http://apps.bdimg.com/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>
    var $itemWidth = $('.item').outerWidth(true);
var $load = $('#load');
var locked = false;
var itemlist;
// 获取新闻的页数和每页的数量
var pageIndex = 1;
var pageCount = 10;

function reckonCal() {
  itemlist = [];
  // 通过大容器计算出有多少列
  var calNum = parseInt($('.container').width() / $itemWidth);
  console.log($('.container').width(), $itemWidth );
  // 将每列的高度初始化
  for (var i = 0; i < calNum; i++) {
    itemlist[i] = 0;
  }
  console.log(itemlist);
}

// 每次结束需要容器的高度必须是CSS设置的
// 1.获取数据
// 2. 一张图加载完成后创一个DOM,以瀑布流的方式放入
// 3.滚动到底部又到第一步

getData(function (newsList) {
    reckonCal();
    $.each(newsList, function(index, value) {
    var $node = creatDom(value);
    $node.find('img').load(function () {

      // 瀑布流需要先把元素放入,然后再排位置
      $('.pic-ct').append($node);
       waterFallPlace($node);
    });
  });
});

// 当窗口滚动触发事件
$(window).on('scroll', function () {
  if (locked) return;
  if (isShow()) {
    locked = true;
    getData(function (newsList) {
        $.each(newsList, function(index, value) {
        var $node = creatDom(value);
        $node.find('img').load(function () {

          // 瀑布流需要先把元素放入,然后再排位置
          $('.pic-ct').append($node);
          waterFallPlace($node);
        });
      });
      locked = false;
    });
  }
});

// 当窗口发发生变化的时候
$(window).on('resize', function () {
  reckonCal();
  $.each($('.pic-ct>li:not(:first-child)'), function (index, value) {
     waterFallPlace($(value));
  });
});

// jsonp获取数据,然后页数加一
function getData(callback) {
  $.ajax({
    url: 'http://platform.sina.com.cn/slide/album_tech',
    dataType: 'jsonp',
    jsonp:"jsoncallback",
    data: {
      app_key: '1271687855',
      num: pageCount,
      page: pageIndex
    }
  }).done(function(msg) {

    if (msg && msg.status && msg.status.code === "0") {
      callback(msg.data);
      pageIndex++;
     }
  });
}

// 创建dom
function creatDom(el) {
  var html = "";
  html += '<li class="item">';
  html += '<a href="'+ el.url +'">';
  html += '<img src="'+ el.img_url +'" alt=""></a>';
  html +=  '<h4>'+ el.short_name +'</h4>';
  html +=  '<p>'+ el.short_intro +'</p>';
  html +=  '</li>';

  return $(html);
}

// 将通过瀑布流的方式放入
function waterFallPlace($node) {
  //首先先获取数组最小的高度.然后再获取到坐标. css定位为top为数组的高度.left为坐标*本身的outerWidth(true)的宽度

  var $minHeight = Math.min.apply(null, itemlist);
  var index = itemlist.indexOf($minHeight);
  $node.css({
    top: $minHeight,
    left: index * $itemWidth,
    opacity: 1
  });
  itemlist[index] += $node.outerHeight(true);
   $('.pic-ct').height(Math.max.apply(null, itemlist));
}

// 判断锚点是否出现
function isShow() {
  var $scroll = $(window).scrollTop();
  var $windowHeight = $(window).height();
  var $loadHeight = $load.offset().top;

  console.log('hhh');
  console.log($windowHeight);
  console.log($scroll);
  console.log($loadHeight);

  if ($loadHeight < $scroll + $windowHeight) {
    return true;
  }
  return false;
}
  </script>
</body>
</html>